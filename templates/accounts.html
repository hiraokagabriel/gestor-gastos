{% extends "base.html" %}

{% block title %}Lançamentos - Gestor de Gastos{% endblock %}

{% block extra_css %}
<style>
.card-stat {
    transition: transform 0.2s;
}
.card-stat:hover {
    transform: translateY(-5px);
}
.badge-consolidated {
    background-color: #28a745;
}
.badge-pending {
    background-color: #ffc107;
    color: #000;
}
.badge-recurring-origin {
    background-color: #6f42c1;
    color: white;
}
.badge-recurring-child {
    background-color: #e83e8c;
    color: white;
}
.badge-unique {
    background-color: #6c757d;
    color: white;
}
.table-actions {
    white-space: nowrap;
}
.row-recurring-child {
    background-color: #fff5f8 !important;
}
.row-consolidated {
    background-color: #f0fff4 !important;
}
.legend-item {
    display: inline-block;
    margin-right: 15px;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
}
.icon-tooltip {
    cursor: help;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-money-bill-wave"></i> Lançamentos Financeiros</h2>
        <p class="text-muted">Gerencie receitas e despesas com sistema de consolidação</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-success me-2" onclick="openAccountModal('income')">
            <i class="fas fa-plus"></i> Nova Receita
        </button>
        <button class="btn btn-danger" onclick="openAccountModal('expense')">
            <i class="fas fa-minus"></i> Nova Despesa
        </button>
    </div>
</div>

<!-- Filtro de Mês/Ano -->
<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label"><i class="fas fa-calendar"></i> Período:</label>
        <div class="input-group">
            <select class="form-select" id="filterMonth" onchange="loadData()">
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
            <input type="number" class="form-control" id="filterYear" placeholder="Ano" value="2026" onchange="loadData()">
        </div>
    </div>
    <div class="col-md-8">
        <!-- Legenda Visual -->
        <label class="form-label"><i class="fas fa-info-circle"></i> Legenda:</label>
        <div>
            <span class="legend-item badge-consolidated">
                <i class="fas fa-check-circle"></i> Consolidado (pago/recebido)
            </span>
            <span class="legend-item badge-pending">
                <i class="fas fa-clock"></i> Pendente (a pagar/receber)
            </span>
            <span class="legend-item badge-recurring-origin" style="background-color: #6f42c1;">
                <i class="fas fa-sync-alt"></i> Origem Recorrente
            </span>
            <span class="legend-item badge-recurring-child" style="background-color: #e83e8c;">
                <i class="fas fa-copy"></i> Gerado Automaticamente
            </span>
        </div>
    </div>
</div>

<!-- Cards de Resumo -->
<div class="row mb-4">
    <!-- Receitas -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-stat border-success shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-success"><i class="fas fa-arrow-up"></i> Receitas</h6>
                <h4 class="text-success mb-1" id="totalIncome">R$ 0,00</h4>
                <small class="text-muted">Consolidadas: <strong id="incomeConsolidated">R$ 0,00</strong></small><br>
                <small class="text-muted">Pendentes: <strong id="incomePending">R$ 0,00</strong></small>
            </div>
        </div>
    </div>
    
    <!-- Despesas -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-stat border-danger shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-danger"><i class="fas fa-arrow-down"></i> Despesas</h6>
                <h4 class="text-danger mb-1" id="totalExpenses">R$ 0,00</h4>
                <small class="text-muted">Consolidadas: <strong id="expenseConsolidated">R$ 0,00</strong></small><br>
                <small class="text-muted">Não Consolidadas: <strong class="text-warning" id="expensePending">R$ 0,00</strong></small>
            </div>
        </div>
    </div>
    
    <!-- Saldo em Caixa -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-stat border-primary shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-primary"><i class="fas fa-wallet"></i> Saldo em Caixa</h6>
                <h4 class="mb-0" id="balanceConsolidated">R$ 0,00</h4>
                <small class="text-muted">(Apenas consolidados)</small>
            </div>
        </div>
    </div>
    
    <!-- Saldo Total -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card card-stat border-info shadow-sm">
            <div class="card-body">
                <h6 class="card-title text-info"><i class="fas fa-chart-line"></i> Saldo Total</h6>
                <h4 class="mb-0" id="balanceTotal">R$ 0,00</h4>
                <small class="text-muted">(Consolidados + Pendentes)</small>
            </div>
        </div>
    </div>
</div>

<!-- Filtros de Status e Tipo -->
<div class="row mb-3">
    <div class="col">
        <div class="btn-group me-3" role="group">
            <button type="button" class="btn btn-outline-secondary active" data-filter="all" onclick="filterByStatus('all')">
                <i class="fas fa-list"></i> Todos
            </button>
            <button type="button" class="btn btn-outline-warning" data-filter="pending" onclick="filterByStatus('pending')">
                <i class="fas fa-clock"></i> Pendentes
            </button>
            <button type="button" class="btn btn-outline-success" data-filter="consolidated" onclick="filterByStatus('consolidated')">
                <i class="fas fa-check-circle"></i> Consolidados
            </button>
        </div>
        
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success" onclick="filterByType('income')">
                <i class="fas fa-arrow-up"></i> Receitas
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="filterByType('expense')">
                <i class="fas fa-arrow-down"></i> Despesas
            </button>
        </div>
    </div>
</div>

<!-- Lista de Lançamentos -->
<div id="accountsList">
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>
</div>

<!-- Modal para Adicionar/Editar Conta -->
<div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalTitle">Novo Lançamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    <input type="hidden" id="accountType">
                    <div class="mb-3">
                        <label for="accountDescription" class="form-label">Descrição *</label>
                        <input type="text" class="form-control" id="accountDescription" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accountAmount" class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-control" id="accountAmount" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accountDate" class="form-label">Data *</label>
                            <input type="date" class="form-control" id="accountDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="accountCategory" class="form-label">Categoria</label>
                        <input type="text" class="form-control" id="accountCategory" list="accountCategories">
                        <datalist id="accountCategories">
                            <option value="Salário">
                            <option value="Freelance">
                            <option value="Investimentos">
                            <option value="Alimentação">
                            <option value="Transporte">
                            <option value="Moradia">
                            <option value="Lazer">
                            <option value="Saúde">
                            <option value="Educação">
                            <option value="Assinaturas">
                            <option value="Outros">
                        </datalist>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="accountRecurring">
                                <label class="form-check-label" for="accountRecurring">
                                    <i class="fas fa-sync"></i> Recorrente (mensal)
                                </label>
                                <br>
                                <small class="text-muted">Gerará automaticamente próximos 12 meses</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="accountConsolidated">
                                <label class="form-check-label" for="accountConsolidated">
                                    <i class="fas fa-check-circle"></i> Já consolidado
                                </label>
                                <br>
                                <small class="text-muted">Já foi pago/recebido</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAccount()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFilter = 'all';
let currentTypeFilter = null;

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    document.getElementById('filterMonth').value = today.getMonth() + 1;
    document.getElementById('filterYear').value = today.getFullYear();
    
    loadData();
});

async function loadData() {
    await loadSummary();
    await loadAccounts();
}

async function loadSummary() {
    const month = document.getElementById('filterMonth').value;
    const year = document.getElementById('filterYear').value;
    
    try {
        const response = await fetch(`/accounts/api/accounts/summary?month=${month}&year=${year}`);
        const summary = await response.json();
        
        document.getElementById('totalIncome').textContent = `R$ ${summary.income_total.toFixed(2)}`;
        document.getElementById('incomeConsolidated').textContent = `R$ ${summary.income_consolidated.toFixed(2)}`;
        document.getElementById('incomePending').textContent = `R$ ${summary.income_pending.toFixed(2)}`;
        
        document.getElementById('totalExpenses').textContent = `R$ ${summary.expense_total.toFixed(2)}`;
        document.getElementById('expenseConsolidated').textContent = `R$ ${summary.expense_consolidated.toFixed(2)}`;
        document.getElementById('expensePending').textContent = `R$ ${summary.expense_pending.toFixed(2)}`;
        
        const consolidatedEl = document.getElementById('balanceConsolidated');
        consolidatedEl.textContent = `R$ ${summary.balance_consolidated.toFixed(2)}`;
        consolidatedEl.className = summary.balance_consolidated >= 0 ? 'text-success mb-0' : 'text-danger mb-0';
        
        const totalEl = document.getElementById('balanceTotal');
        totalEl.textContent = `R$ ${summary.balance_total.toFixed(2)}`;
        totalEl.className = summary.balance_total >= 0 ? 'text-success mb-0' : 'text-danger mb-0';
        
    } catch (error) {
        console.error('Erro ao carregar resumo:', error);
    }
}

async function loadAccounts() {
    const month = document.getElementById('filterMonth').value;
    const year = document.getElementById('filterYear').value;
    
    try {
        let url = `/accounts/api/accounts?month=${month}&year=${year}`;
        
        if (currentFilter !== 'all') {
            url += `&status=${currentFilter}`;
        }
        
        if (currentTypeFilter) {
            url += `&type=${currentTypeFilter}`;
        }
        
        const response = await fetch(url);
        const accounts = await response.json();
        
        const accountsList = document.getElementById('accountsList');
        
        if (accounts.length === 0) {
            accountsList.innerHTML = '<div class="alert alert-info text-center"><i class="fas fa-info-circle"></i> Nenhum lançamento encontrado</div>';
            return;
        }
        
        accountsList.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th width="90">Data</th>
                                    <th>Descrição</th>
                                    <th width="120">Categoria</th>
                                    <th width="100" class="text-center">Tipo</th>
                                    <th width="120" class="text-end">Valor</th>
                                    <th width="130" class="text-center">Status</th>
                                    <th width="120" class="text-center">Origem</th>
                                    <th width="180" class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${accounts.map(acc => {
                                    const rowClass = acc.consolidated ? 'row-consolidated' : 
                                                   (acc.is_recurring_child ? 'row-recurring-child' : '');
                                    
                                    let originBadge = '';
                                    if (acc.is_recurring_origin) {
                                        originBadge = `<span class="badge badge-recurring-origin" title="Esta é a conta original. Ela gera cópias automaticamente todo mês."><i class="fas fa-sync-alt"></i> Origem</span>`;
                                    } else if (acc.is_recurring_child) {
                                        originBadge = `<span class="badge badge-recurring-child" title="Esta conta foi gerada automaticamente pela recorrência."><i class="fas fa-copy"></i> Auto</span>`;
                                    } else {
                                        originBadge = `<span class="badge badge-unique" title="Lançamento único, não recorrente."><i class="fas fa-file"></i> Único</span>`;
                                    }
                                    
                                    return `
                                        <tr class="${rowClass}">
                                            <td><small>${new Date(acc.date).toLocaleDateString('pt-BR')}</small></td>
                                            <td>
                                                <strong>${acc.description}</strong>
                                            </td>
                                            <td><span class="badge bg-secondary">${acc.category || 'Sem cat.'}</span></td>
                                            <td class="text-center">
                                                <span class="badge bg-${acc.type === 'income' ? 'success' : 'danger'}">
                                                    <i class="fas fa-arrow-${acc.type === 'income' ? 'up' : 'down'}"></i>
                                                    ${acc.type === 'income' ? 'Receita' : 'Despesa'}
                                                </span>
                                            </td>
                                            <td class="text-end fw-bold ${acc.type === 'income' ? 'text-success' : 'text-danger'}">
                                                ${acc.type === 'income' ? '+' : '-'} R$ ${acc.amount.toFixed(2)}
                                            </td>
                                            <td class="text-center">
                                                <span class="badge ${acc.consolidated ? 'badge-consolidated' : 'badge-pending'}" title="${acc.consolidated ? 'Este lançamento já foi pago/recebido' : 'Este lançamento ainda não foi pago/recebido'}">
                                                    <i class="fas fa-${acc.consolidated ? 'check-circle' : 'clock'}"></i>
                                                    ${acc.status}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                ${originBadge}
                                            </td>
                                            <td class="text-center table-actions">
                                                ${!acc.consolidated ? `
                                                    <button class="btn btn-sm btn-success" onclick="consolidateAccount(${acc.id})" title="Marcar como pago/recebido">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                ` : `
                                                    <button class="btn btn-sm btn-warning" onclick="unconsolidateAccount(${acc.id})" title="Reverter consolidação">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                `}
                                                ${!acc.is_recurring_child ? `
                                                    <button class="btn btn-sm btn-primary" onclick="editAccount(${acc.id})" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                ` : ''}
                                                ${acc.is_recurring_origin || acc.is_recurring_child ? `
                                                    <button class="btn btn-sm btn-danger" onclick="deleteAccountSeries(${acc.id})" title="Excluir TODA a série recorrente">
                                                        <i class="fas fa-trash-alt"></i> Série
                                                    </button>
                                                ` : `
                                                    <button class="btn btn-sm btn-danger" onclick="deleteAccount(${acc.id})" title="Excluir">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao carregar lançamentos:', error);
    }
}

function filterByStatus(status) {
    currentFilter = status;
    document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-filter="${status}"]`).classList.add('active');
    loadAccounts();
}

function filterByType(type) {
    if (currentTypeFilter === type) {
        currentTypeFilter = null;
        event.target.classList.remove('active');
    } else {
        document.querySelectorAll('.btn-group:last-child button').forEach(btn => btn.classList.remove('active'));
        currentTypeFilter = type;
        event.target.classList.add('active');
    }
    loadAccounts();
}

function openAccountModal(type) {
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    document.getElementById('accountType').value = type;
    document.getElementById('accountModalTitle').innerHTML = `
        <i class="fas fa-${type === 'income' ? 'arrow-up' : 'arrow-down'}"></i>
        ${type === 'income' ? 'Nova Receita' : 'Nova Despesa'}
    `;
    
    const today = new Date();
    document.getElementById('accountDate').valueAsDate = today;
    
    new bootstrap.Modal(document.getElementById('accountModal')).show();
}

async function editAccount(accountId) {
    try {
        const response = await fetch(`/accounts/api/accounts/${accountId}`);
        const account = await response.json();
        
        document.getElementById('accountId').value = account.id;
        document.getElementById('accountType').value = account.type;
        document.getElementById('accountDescription').value = account.description;
        document.getElementById('accountAmount').value = account.amount;
        document.getElementById('accountDate').value = account.date;
        document.getElementById('accountCategory').value = account.category || '';
        document.getElementById('accountRecurring').checked = account.recurring;
        document.getElementById('accountConsolidated').checked = account.consolidated;
        
        document.getElementById('accountModalTitle').innerHTML = `
            <i class="fas fa-edit"></i>
            Editar ${account.type === 'income' ? 'Receita' : 'Despesa'}
        `;
        
        new bootstrap.Modal(document.getElementById('accountModal')).show();
    } catch (error) {
        console.error('Erro ao carregar lançamento:', error);
        alert('Erro ao carregar lançamento');
    }
}

async function saveAccount() {
    const accountId = document.getElementById('accountId').value;
    const data = {
        description: document.getElementById('accountDescription').value,
        amount: document.getElementById('accountAmount').value,
        type: document.getElementById('accountType').value,
        date: document.getElementById('accountDate').value,
        category: document.getElementById('accountCategory').value,
        recurring: document.getElementById('accountRecurring').checked,
        consolidated: document.getElementById('accountConsolidated').checked
    };
    
    try {
        const url = accountId ? `/accounts/api/accounts/${accountId}` : '/accounts/api/accounts';
        const method = accountId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
            
            // Mostrar mensagem se gerou recorrências
            if (result.generated_count > 0) {
                alert(`✅ Sucesso! ${result.generated_count} meses gerados automaticamente.`);
            }
            
            loadData();
        } else {
            alert('Erro ao salvar lançamento');
        }
    } catch (error) {
        console.error('Erro ao salvar lançamento:', error);
        alert('Erro ao salvar lançamento');
    }
}

async function consolidateAccount(accountId) {
    if (!confirm('Consolidar este lançamento? Ele afetará o saldo em caixa.')) return;
    
    try {
        const response = await fetch(`/accounts/api/accounts/${accountId}/consolidate`, { method: 'POST' });
        if (response.ok) {
            loadData();
        } else {
            const error = await response.json();
            alert(error.error || 'Erro ao consolidar');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao consolidar');
    }
}

async function unconsolidateAccount(accountId) {
    if (!confirm('Reverter consolidação deste lançamento?')) return;
    
    try {
        const response = await fetch(`/accounts/api/accounts/${accountId}/unconsolidate`, { method: 'POST' });
        if (response.ok) {
            loadData();
        } else {
            const error = await response.json();
            alert(error.error || 'Erro');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro');
    }
}

async function deleteAccount(accountId) {
    if (!confirm('Tem certeza que deseja excluir este lançamento?')) return;
    
    try {
        const response = await fetch(`/accounts/api/accounts/${accountId}`, { method: 'DELETE' });
        if (response.ok) {
            loadData();
        } else {
            alert('Erro ao deletar');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar');
    }
}

async function deleteAccountSeries(accountId) {
    if (!confirm('⚠️ ATENÇÃO! Isso vai excluir TODA a série recorrente (origem + todas as instâncias geradas). Continuar?')) return;
    
    try {
        const response = await fetch(`/accounts/api/accounts/${accountId}/delete-series`, { method: 'DELETE' });
        if (response.ok) {
            const result = await response.json();
            alert(`✅ ${result.message}`);
            loadData();
        } else {
            const error = await response.json();
            alert(error.error || 'Erro ao deletar série');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar série');
    }
}
</script>
{% endblock %}