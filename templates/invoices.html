{% extends 'base.html' %}

{% block title %}Faturas - Gestor de Gastos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="fas fa-file-invoice-dollar"></i> Faturas</h2>
            <p class="text-muted mb-0">Acompanhe por status (aberta/fechada/paga) e veja prazos com clareza.</p>
        </div>
        <div class="col text-end">
            <a class="btn btn-outline-secondary" href="/">
                <i class="fas fa-calendar-alt"></i> Voltar para Agenda
            </a>
        </div>
    </div>

    <!-- Chip de filtro ativo (card) -->
    <div id="activeFilters" class="mb-2" style="display:none;"></div>

    <!-- Tabs por status -->
    <ul class="nav nav-tabs" id="invoiceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-open" data-bs-toggle="tab" data-bs-target="#pane-open" type="button" role="tab">
                Abertas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-closed" data-bs-toggle="tab" data-bs-target="#pane-closed" type="button" role="tab">
                Fechadas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-paid" data-bs-toggle="tab" data-bs-target="#pane-paid" type="button" role="tab">
                Pagas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-history" data-bs-toggle="tab" data-bs-target="#pane-history" type="button" role="tab">
                Histórico
            </button>
        </li>
    </ul>

    <div class="tab-content pt-3">
        <!-- Abertas -->
        <div class="tab-pane fade show active" id="pane-open" role="tabpanel">
            <div id="openList" class="row"></div>
            <div id="openEmpty" class="alert alert-info" style="display:none;">
                <i class="fas fa-info-circle"></i> Nenhuma fatura aberta no período.
            </div>
        </div>

        <!-- Fechadas -->
        <div class="tab-pane fade" id="pane-closed" role="tabpanel">
            <div id="closedList" class="row"></div>
            <div id="closedEmpty" class="alert alert-info" style="display:none;">
                <i class="fas fa-info-circle"></i> Nenhuma fatura fechada no período.
            </div>
        </div>

        <!-- Pagas -->
        <div class="tab-pane fade" id="pane-paid" role="tabpanel">
            <div id="paidList" class="row"></div>
            <div id="paidEmpty" class="alert alert-info" style="display:none;">
                <i class="fas fa-info-circle"></i> Nenhuma fatura paga no período.
            </div>
        </div>

        <!-- Histórico (mês/ano) -->
        <div class="tab-pane fade" id="pane-history" role="tabpanel">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Mês</label>
                            <select class="form-select" id="historyMonth"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ano</label>
                            <select class="form-select" id="historyYear"></select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="loadHistory(); return false;">
                                <i class="fas fa-search"></i> Carregar
                            </button>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">Use o histórico para consultar um mês específico.</div>
                </div>
            </div>

            <div id="historyList" class="row"></div>
            <div id="historyEmpty" class="alert alert-info" style="display:none;">
                <i class="fas fa-info-circle"></i> Nenhuma fatura para este mês/ano.
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes (compacto por compra) -->
<div class="modal fade" id="invoiceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoiceDetailsTitle">Detalhes da Fatura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="invoiceMeta" class="mb-3"></div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Compra</th>
                                <th class="text-end">Total</th>
                                <th>Parcelas nesta fatura</th>
                                <th class="text-end">Parcela</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="detailsBody"></tbody>
                    </table>
                </div>
                <div class="text-muted small">Clique em uma linha para ver as parcelas individuais (MVP: ainda não expande).</div>
            </div>
        </div>
    </div>
</div>

<script>
const monthNames = ['', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

function _fmtMoney(v) {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
}

function _fmtDate(iso) {
    try {
        const [y, m, d] = iso.split('-').map(Number);
        return new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo' }).format(new Date(y, m - 1, d));
    } catch (e) {
        return iso;
    }
}

function _badge(status) {
    if (status === 'paid') return '<span class="badge bg-success">Paga</span>';
    if (status === 'closed') return '<span class="badge bg-warning">Fechada</span>';
    return '<span class="badge bg-primary">Aberta</span>';
}

function _statusHelp(inv) {
    if (!inv) return '';
    const due = inv.due_date ? _fmtDate(inv.due_date) : '—';
    const close = inv.closing_date ? _fmtDate(inv.closing_date) : '—';
    const dueTxt = (typeof inv.days_to_due === 'number') ? `${inv.days_to_due}d` : '—';
    const closeTxt = (typeof inv.days_to_close === 'number') ? `${inv.days_to_close}d` : '—';

    return `
        <div class="small text-muted">Fecha: ${close} (${closeTxt}) · Vence: ${due} (${dueTxt})</div>
    `;
}

function _cardHtml(item) {
    const inv = item.invoice;
    const card = item.card;
    const amount = item.amount || 0;

    const invId = inv ? inv.id : null;
    const canPay = inv && inv.status !== 'paid';
    const canUnpay = inv && inv.status === 'paid';

    return `
        <div class="col-md-6 mb-3">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold"><i class="fas fa-credit-card"></i> ${card.name} <span class="text-muted small">**** ${card.last_digits || ''}</span></div>
                        ${inv ? _statusHelp(inv) : '<div class="small text-muted">Sem fatura gerada (valor 0).</div>'}
                    </div>
                    <div>${inv ? _badge(inv.status) : '<span class="badge bg-secondary">—</span>'}</div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-muted">Total</div>
                            <div class="h4 mb-0">${_fmtMoney(amount)}</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted">Parcelas</div>
                            <div class="h4 mb-0">${item.installments_count || 0}</div>
                        </div>
                    </div>
                    ${inv && inv.status === 'paid' && inv.paid_date ? `
                        <div class="alert alert-success mt-3 mb-0 py-2">
                            Pago em ${_fmtDate(inv.paid_date)}
                        </div>
                    ` : ''}
                </div>
                <div class="card-footer">
                    <div class="btn-group w-100" role="group">
                        <button class="btn btn-outline-primary" onclick='showDetails(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                            <i class="fas fa-list"></i> Detalhes
                        </button>
                        ${canPay ? `
                            <button class="btn btn-success" onclick="payInvoice(${invId})">
                                <i class="fas fa-check"></i> Pagar
                            </button>
                        ` : ''}
                        ${canUnpay ? `
                            <button class="btn btn-warning" onclick="unpayInvoice(${invId})">
                                <i class="fas fa-undo"></i> Despagar
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function _groupByStatus(invoices) {
    const open = [];
    const closed = [];
    const paid = [];

    invoices.forEach(it => {
        if (!it.invoice) return;
        if (it.invoice.status === 'paid') paid.push(it);
        else if (it.invoice.status === 'closed') closed.push(it);
        else open.push(it);
    });

    return { open, closed, paid };
}

async function _fetchInvoices(month, year, status, cardId) {
    const qs = new URLSearchParams({ month, year, status });
    if (cardId) qs.set('card_id', String(cardId));

    const r = await fetch(`/invoices/api/invoices?${qs.toString()}`);
    if (!r.ok) throw new Error('Erro ao carregar faturas');
    return await r.json();
}

function _render(listElId, emptyElId, data) {
    const listEl = document.getElementById(listElId);
    const emptyEl = document.getElementById(emptyElId);

    listEl.innerHTML = '';
    if (!data || data.length === 0) {
        emptyEl.style.display = 'block';
        return;
    }

    emptyEl.style.display = 'none';
    data.forEach(item => {
        listEl.innerHTML += _cardHtml(item);
    });
}

function _activateTab(tabName) {
    const map = {
        open: { btn: 'tab-open' },
        closed: { btn: 'tab-closed' },
        paid: { btn: 'tab-paid' },
        history: { btn: 'tab-history' }
    };

    const t = map[tabName];
    if (!t) return;

    const btn = document.getElementById(t.btn);
    if (!btn) return;

    const tab = new bootstrap.Tab(btn);
    tab.show();
}

function _getQS() {
    const p = new URLSearchParams(window.location.search);
    return {
        tab: p.get('tab') || 'open',
        month: p.get('month'),
        year: p.get('year'),
        card_id: p.get('card_id')
    };
}

function _renderActiveFilters(qs, sampleCardName) {
    const wrap = document.getElementById('activeFilters');
    if (!wrap) return;

    if (!qs.card_id) {
        wrap.style.display = 'none';
        wrap.innerHTML = '';
        return;
    }

    const name = sampleCardName || `Cartão #${qs.card_id}`;

    // Mantém month/year/tab, remove card_id
    const url = new URL(window.location.href);
    url.searchParams.delete('card_id');

    wrap.style.display = 'block';
    wrap.innerHTML = `
        <span class="badge bg-info text-dark me-2">
            Filtrando: ${name}
        </span>
        <a class="btn btn-sm btn-outline-secondary" href="${url.pathname}?${url.searchParams.toString()}">
            Limpar filtro
        </a>
    `;
}

async function loadCurrent() {
    const now = new Date();
    const qs = _getQS();

    const month = parseInt(qs.month || String(now.getMonth() + 1));
    const year = parseInt(qs.year || String(now.getFullYear()));
    const cardId = qs.card_id ? parseInt(qs.card_id) : null;

    const all = await _fetchInvoices(month, year, 'all', cardId);
    const grouped = _groupByStatus(all);

    _render('openList', 'openEmpty', grouped.open);
    _render('closedList', 'closedEmpty', grouped.closed);
    _render('paidList', 'paidEmpty', grouped.paid);

    // Exibir chip de filtro usando o nome vindo do payload (primeiro item basta)
    const sampleCardName = (all && all.length > 0 && all[0].card && all[0].card.name) ? all[0].card.name : null;
    _renderActiveFilters(qs, sampleCardName);

    if (qs.tab === 'history') {
        document.getElementById('historyMonth').value = String(month);
        document.getElementById('historyYear').value = String(year);
        await loadHistory();
    }

    _activateTab(qs.tab);
}

function _fillHistorySelectors() {
    const mSel = document.getElementById('historyMonth');
    const ySel = document.getElementById('historyYear');

    const now = new Date();

    mSel.innerHTML = '';
    for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = monthNames[m];
        if (m === (now.getMonth() + 1)) opt.selected = true;
        mSel.appendChild(opt);
    }

    ySel.innerHTML = '';
    const base = now.getFullYear();
    for (let y = base - 2; y <= base + 1; y++) {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        if (y === base) opt.selected = true;
        ySel.appendChild(opt);
    }
}

async function loadHistory() {
    const month = parseInt(document.getElementById('historyMonth').value);
    const year = parseInt(document.getElementById('historyYear').value);
    const qs = _getQS();
    const cardId = qs.card_id ? parseInt(qs.card_id) : null;

    const all = await _fetchInvoices(month, year, 'all', cardId);

    const listEl = document.getElementById('historyList');
    const emptyEl = document.getElementById('historyEmpty');

    listEl.innerHTML = '';

    if (!all || all.length === 0) {
        emptyEl.style.display = 'block';
        return;
    }

    emptyEl.style.display = 'none';
    all.forEach(item => {
        listEl.innerHTML += _cardHtml(item);
    });
}

function showDetails(item) {
    const inv = item.invoice;
    const card = item.card;

    document.getElementById('invoiceDetailsTitle').textContent = `Detalhes — ${card.name}`;

    const meta = document.getElementById('invoiceMeta');
    if (inv) {
        meta.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div>${_badge(inv.status)} <span class="ms-2 text-muted">${monthNames[inv.month]}/${inv.year}</span></div>
                    <div class="text-muted small">Fecha: ${_fmtDate(inv.closing_date)} · Vence: ${_fmtDate(inv.due_date)}</div>
                </div>
                <div class="text-end">
                    <div class="text-muted small">Total</div>
                    <div class="h5 mb-0">${_fmtMoney(item.amount)}</div>
                </div>
            </div>
        `;
    } else {
        meta.innerHTML = '<div class="text-muted">Sem fatura gerada.</div>';
    }

    const tbody = document.getElementById('detailsBody');
    tbody.innerHTML = '';

    const installments = item.installments || [];
    if (!installments.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma parcela</td></tr>';
    } else {
        const txMap = {};
        installments.forEach(inst => {
            const tid = inst.transaction_id;
            if (!txMap[tid]) txMap[tid] = [];
            txMap[tid].push(inst);
        });

        Object.values(txMap).forEach(group => {
            const first = group[0];
            const total = (first.amount || 0) * (first.total_installments || 0);

            const paidCount = group.filter(x => x.paid).length;
            const groupStatus = (paidCount === group.length) ? 'paid' : (paidCount > 0 ? 'open' : (inv ? inv.status : 'open'));

            tbody.innerHTML += `
                <tr>
                    <td>${first.description || 'Compra'}</td>
                    <td class="text-end">${_fmtMoney(total)}</td>
                    <td>${group.length} parcela(s) nesta fatura</td>
                    <td class="text-end">${_fmtMoney(first.amount)}</td>
                    <td>${_badge(groupStatus)}</td>
                </tr>
            `;
        });
    }

    new bootstrap.Modal(document.getElementById('invoiceDetailsModal')).show();
}

async function payInvoice(id) {
    if (!confirm('Deseja marcar esta fatura como paga?')) return;
    const r = await fetch(`/invoices/api/invoices/${id}/pay`, { method: 'POST' });
    if (!r.ok) {
        alert('Erro ao pagar fatura');
        return;
    }
    await loadCurrent();
}

async function unpayInvoice(id) {
    if (!confirm('Deseja despagar esta fatura?')) return;
    const r = await fetch(`/invoices/api/invoices/${id}/unpay`, { method: 'POST' });
    if (!r.ok) {
        alert('Erro ao despagar fatura');
        return;
    }
    await loadCurrent();
}

document.addEventListener('DOMContentLoaded', async () => {
    _fillHistorySelectors();
    await loadCurrent();
});
</script>
{% endblock %}
