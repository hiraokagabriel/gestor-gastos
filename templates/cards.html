{% extends "base.html" %}

{% block title %}Cartões - Gestor de Gastos{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-credit-card"></i> Meus Cartões</h2>
    </div>
    <div class="col text-end">
        <a class="btn btn-outline-primary me-2" href="/invoices">
            <i class="fas fa-file-invoice-dollar"></i> Faturas
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cardModal" onclick="openCardModal()">
            <i class="fas fa-plus"></i> Novo Cartão
        </button>
    </div>
</div>

<div id="cardsList" class="row g-4">
    <!-- Cards serão carregados aqui -->
</div>

<!-- Modal para Adicionar/Editar Cartão -->
<div class="modal fade" id="cardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardModalTitle">Novo Cartão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cardForm">
                    <input type="hidden" id="cardId">

                    <div class="mb-3">
                        <label for="cardName" class="form-label">Nome do Cartão *</label>
                        <input type="text" class="form-control" id="cardName" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cardFlag" class="form-label">Bandeira</label>
                            <select class="form-select" id="cardFlag">
                                <option value="">(Não informado)</option>
                                <option value="Visa">Visa</option>
                                <option value="Mastercard">Mastercard</option>
                                <option value="Elo">Elo</option>
                                <option value="American Express">American Express</option>
                                <option value="Hipercard">Hipercard</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cardDigits" class="form-label">Últimos 4 dígitos</label>
                            <input type="text" class="form-control" id="cardDigits" maxlength="4" pattern="[0-9]{4}">
                            <small class="text-muted">Opcional</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cardExpiryMonth" class="form-label">Validade (mês)</label>
                            <input type="number" class="form-control" id="cardExpiryMonth" min="1" max="12" placeholder="MM">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cardExpiryYear" class="form-label">Validade (ano)</label>
                            <input type="number" class="form-control" id="cardExpiryYear" min="2000" max="2100" placeholder="YYYY">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cardLimit" class="form-label">Limite Total (R$)</label>
                        <input type="number" class="form-control" id="cardLimit" step="0.01" placeholder="0,00">
                        <small class="text-muted">Opcional (se vazio, será 0)</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cardClosingDay" class="form-label">Dia do Fechamento</label>
                            <input type="number" class="form-control" id="cardClosingDay" min="1" max="31">
                            <small class="text-muted">Opcional (se vazio, será 1)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cardDueDay" class="form-label">Dia do Vencimento</label>
                            <input type="number" class="form-control" id="cardDueDay" min="1" max="60">
                            <small class="text-muted">Opcional (se vazio, será fechamento + 7 dias)</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCard()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Transações -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalTitle">Nova Compra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionCardId">
                    <input type="hidden" id="transactionId">
                    <div class="mb-3">
                        <label for="transactionDescription" class="form-label">Descrição *</label>
                        <input type="text" class="form-control" id="transactionDescription" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="transactionAmount" class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-control" id="transactionAmount" step="0.01" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="transactionDate" class="form-label">Data *</label>
                            <input type="date" class="form-control" id="transactionDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="transactionCategory" class="form-label">Categoria</label>
                            <input type="text" class="form-control" id="transactionCategory" list="categories">
                            <datalist id="categories">
                                <option value="Alimentação">
                                <option value="Transporte">
                                <option value="Lazer">
                                <option value="Saúde">
                                <option value="Educação">
                                <option value="Compras">
                                <option value="Serviços">
                                <option value="Outros">
                            </datalist>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="transactionInstallments" class="form-label">Parcelas *</label>
                            <input type="number" class="form-control" id="transactionInstallments" min="1" value="1" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Transações -->
<div class="modal fade" id="viewTransactionsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTransactionsTitle">Transações</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="transactionsList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Antecipar Parcelas -->
<div class="modal fade" id="anticipateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Antecipar parcelas</h5>
                <button type="button" class="btn btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="anticipateTransactionId">
                <input type="hidden" id="anticipateCardId">

                <div class="alert alert-info">
                    Regra: se a fatura do mês já fechou, a antecipação vai para a próxima fatura; caso contrário, vai para a fatura atual.
                </div>

                <div class="mb-3">
                    <strong id="anticipateTxTitle"></strong>
                    <div class="text-muted" id="anticipateTxMeta"></div>
                </div>

                <div id="anticipateInstallments"></div>

                <hr>

                <h6>Juros simples (manual)</h6>
                <div class="row g-2 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Taxa ao mês (%)</label>
                        <input type="number" step="0.01" class="form-control" id="interestRate" value="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Dias</label>
                        <input type="number" step="1" class="form-control" id="interestDays" value="0">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="calcInterest(); return false;">Calcular</button>
                    </div>
                </div>
                <div class="mt-2" id="interestResult" class="text-muted"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmAnticipation()">Antecipar selecionadas</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentCardId = null;

function _ymToNumber(y, m) {
    return (y * 100) + m;
}

function _optValue(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    const v = (el.value || '').toString().trim();
    return v === '' ? null : v;
}

function _parseISODateAsLocal(isoDate) {
    // isoDate = "YYYY-MM-DD" (sem hora) -> criar Date em horário local, sem conversão UTC
    if (!isoDate || typeof isoDate !== 'string') return null;
    const parts = isoDate.split('-').map(Number);
    if (parts.length !== 3) return null;
    const [y, m, d] = parts;
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
}

function _formatDateBR(isoDate) {
    const dt = _parseISODateAsLocal(isoDate);
    if (!dt) return '';
    return new Intl.DateTimeFormat('pt-BR', { timeZone: 'America/Sao_Paulo' }).format(dt);
}

function _isoToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
}

function openTransactionModal(cardId) {
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionCardId').value = cardId;
    document.getElementById('transactionId').value = '';
    document.getElementById('transactionDate').value = _isoToday();
    document.getElementById('transactionModalTitle').textContent = 'Nova Compra';
    new bootstrap.Modal(document.getElementById('transactionModal')).show();
}

async function openEditTransactionModal(transactionId, cardId) {
    try {
        const response = await fetch(`/cards/api/transactions/${transactionId}`);
        const tx = await response.json();

        document.getElementById('transactionCardId').value = cardId;
        document.getElementById('transactionId').value = tx.id;
        document.getElementById('transactionDescription').value = tx.description;
        document.getElementById('transactionAmount').value = tx.amount;
        document.getElementById('transactionDate').value = tx.date;
        document.getElementById('transactionCategory').value = tx.category || '';
        document.getElementById('transactionInstallments').value = tx.installments_total || 1;

        document.getElementById('transactionModalTitle').textContent = 'Editar Compra';
        new bootstrap.Modal(document.getElementById('transactionModal')).show();
    } catch (error) {
        console.error('Erro ao carregar transação:', error);
        showToast('Erro ao carregar transação', 'error');
    }
}

async function saveTransaction() {
    if (!validateForm('transactionForm')) return;

    const transactionId = (document.getElementById('transactionId').value || '').trim();

    const data = {
        card_id: document.getElementById('transactionCardId').value,
        description: document.getElementById('transactionDescription').value,
        amount: document.getElementById('transactionAmount').value,
        date: document.getElementById('transactionDate').value,
        category: document.getElementById('transactionCategory').value,
        installments_total: document.getElementById('transactionInstallments').value
    };

    try {
        const url = transactionId ? `/cards/api/transactions/${transactionId}` : '/cards/api/transactions';
        const method = transactionId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
            showToast(payload.error || 'Erro ao salvar transação', 'error');
            return;
        }

        bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();

        if (transactionId) {
            const reopened = (payload.reopened_invoices || []).map(x => `${String(x.month).padStart(2,'0')}/${x.year}`).join(', ');
            showToast(reopened ? `Transação atualizada. Fatura reaberta: ${reopened}.` : 'Transação atualizada.', 'success');
        } else {
            showToast('Compra registrada com sucesso!', 'success');
        }

        loadCards();
    } catch (error) {
        console.error('Erro ao salvar transação:', error);
        showToast('Erro ao salvar transação', 'error');
    }
}

async function loadCards() {
    try {
        const response = await fetch('/cards/api/cards');
        const cards = await response.json();

        const cardsList = document.getElementById('cardsList');

        if (cards.length === 0) {
            cardsList.innerHTML = `
                <div class="col-12 text-center text-muted py-5">
                    <i class="fas fa-credit-card fa-3x mb-3"></i>
                    <p>Nenhum cartão cadastrado ainda</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cardModal" onclick="openCardModal()">
                        <i class="fas fa-plus"></i> Cadastrar Primeiro Cartão
                    </button>
                </div>
            `;
            return;
        }

        cardsList.innerHTML = cards.map(card => {
            const usagePercent = card.limit_total > 0 ? (card.total_used / card.limit_total * 100).toFixed(1) : 0;

            const flagLabel = card.flag ? card.flag : 'Sem bandeira';
            const digitsLabel = card.last_digits ? `**** ${card.last_digits}` : '';
            const expiryLabel = (card.expiry_month && card.expiry_year) ? `${String(card.expiry_month).padStart(2,'0')}/${card.expiry_year}` : null;

            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">${card.name}</h5>
                                    <span class="badge bg-secondary">${flagLabel} ${digitsLabel}</span>
                                    ${expiryLabel ? `<div class="small text-muted mt-1">Validade: <strong>${expiryLabel}</strong></div>` : ''}
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-link text-secondary" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#" onclick="editCard(${card.id}); return false;">
                                            <i class="fas fa-edit"></i> Editar
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteCard(${card.id}); return false;">
                                            <i class="fas fa-trash"></i> Excluir
                                        </a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Limite Total</small>
                                    <small class="fw-bold">R$ ${card.limit_total.toFixed(2)}</small>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar ${usagePercent > 80 ? 'bg-danger' : usagePercent > 50 ? 'bg-warning' : 'bg-success'}" 
                                         style="width: ${usagePercent}%" 
                                         title="${usagePercent}% utilizado">
                                        ${usagePercent}%
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-danger">Usado: R$ ${card.total_used.toFixed(2)}</span>
                                    <span class="text-success">Disponível: R$ ${card.limit_available.toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="mb-3 p-2 bg-light rounded">
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">Em aberto (mês atual)</small>
                                    <small class="fw-bold text-primary">R$ ${card.current_bill.toFixed(2)}</small>
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span class="text-muted">Total do mês:</span>
                                    <span>R$ ${(card.current_bill_total || 0).toFixed(2)}</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="row text-center small">
                                    <div class="col-6">
                                        <div class="text-muted">Fechamento</div>
                                        <div class="fw-bold">Dia ${card.closing_day}</div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-muted">Vencimento</div>
                                        <div class="fw-bold">Dia ${card.due_day}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-primary btn-sm" onclick="openTransactionModal(${card.id})">
                                    <i class="fas fa-plus"></i> Nova Compra
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="viewTransactions(${card.id}, '${card.name}')">
                                    <i class="fas fa-list"></i> Ver Transações
                                </button>
                                <button class="btn btn-success btn-sm" onclick="payCurrentInvoice(${card.id})">
                                    <i class="fas fa-check"></i> Pagar fatura (mês atual)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Erro ao carregar cartões:', error);
        showToast('Erro ao carregar cartões', 'error');
    }
}

function openCardModal() {
    document.getElementById('cardForm').reset();
    document.getElementById('cardId').value = '';
    document.getElementById('cardModalTitle').textContent = 'Novo Cartão';
    currentCardId = null;
}

async function editCard(cardId) {
    try {
        const response = await fetch(`/cards/api/cards/${cardId}`);
        const card = await response.json();

        document.getElementById('cardId').value = card.id;
        document.getElementById('cardName').value = card.name;
        document.getElementById('cardFlag').value = card.flag || '';
        document.getElementById('cardDigits').value = card.last_digits || '';
        document.getElementById('cardExpiryMonth').value = card.expiry_month || '';
        document.getElementById('cardExpiryYear').value = card.expiry_year || '';
        document.getElementById('cardLimit').value = card.limit_total;
        document.getElementById('cardClosingDay').value = card.closing_day;
        document.getElementById('cardDueDay').value = card.due_day;

        document.getElementById('cardModalTitle').textContent = 'Editar Cartão';
        currentCardId = cardId;

        new bootstrap.Modal(document.getElementById('cardModal')).show();
    } catch (error) {
        console.error('Erro ao carregar cartão:', error);
        showToast('Erro ao carregar cartão', 'error');
    }
}

async function saveCard() {
    if (!validateForm('cardForm')) return;

    const cardId = document.getElementById('cardId').value;

    const data = {
        name: document.getElementById('cardName').value,
        flag: _optValue('cardFlag'),
        last_digits: _optValue('cardDigits'),
        expiry_month: _optValue('cardExpiryMonth'),
        expiry_year: _optValue('cardExpiryYear'),
        limit_total: _optValue('cardLimit'),
        closing_day: _optValue('cardClosingDay'),
        due_day: _optValue('cardDueDay')
    };

    try {
        const url = cardId ? `/cards/api/cards/${cardId}` : '/cards/api/cards';
        const method = cardId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
            showToast(payload.error || 'Erro ao salvar cartão', 'error');
            return;
        }

        bootstrap.Modal.getInstance(document.getElementById('cardModal')).hide();
        showToast(cardId ? 'Cartão atualizado!' : 'Cartão cadastrado!', 'success');
        loadCards();

    } catch (error) {
        console.error('Erro ao salvar cartão:', error);
        showToast('Erro ao salvar cartão', 'error');
    }
}

async function deleteCard(cardId) {
    if (!confirm('Tem certeza que deseja excluir este cartão? Todas as transações serão perdidas.')) {
        return;
    }

    try {
        const response = await fetch(`/cards/api/cards/${cardId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Cartão excluído com sucesso!', 'success');
            loadCards();
        }
    } catch (error) {
        console.error('Erro ao deletar cartão:', error);
        showToast('Erro ao deletar cartão', 'error');
    }
}

async function payCurrentInvoice(cardId) {
    if (!confirm('Deseja marcar a fatura do mês atual como paga?')) return;

    try {
        const response = await fetch(`/cards/api/cards/${cardId}/pay-current-invoice`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });

        const data = await response.json();
        if (!response.ok) {
            showToast(data.error || 'Erro ao pagar fatura', 'error');
            return;
        }

        showToast('Fatura marcada como paga!', 'success');
        loadCards();
    } catch (error) {
        console.error('Erro ao pagar fatura:', error);
        showToast('Erro ao pagar fatura', 'error');
    }
}

async function viewTransactions(cardId, cardName) {
    try {
        const response = await fetch(`/cards/api/cards/${cardId}/transactions`);
        const transactions = await response.json();

        document.getElementById('viewTransactionsTitle').textContent = `Transações - ${cardName}`;

        const transactionsList = document.getElementById('transactionsList');

        if (transactions.length === 0) {
            transactionsList.innerHTML = '<p class="text-center text-muted py-4">Nenhuma transação encontrada</p>';
            new bootstrap.Modal(document.getElementById('viewTransactionsModal')).show();
            return;
        }

        transactionsList.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor Total</th>
                            <th>Parcelas</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(t => `
                            <tr>
                                <td>${_formatDateBR(t.date)}</td>
                                <td>${t.description}</td>
                                <td><span class="badge bg-info">${t.category || 'Sem categoria'}</span></td>
                                <td class="fw-bold text-primary">R$ ${t.amount.toFixed(2)}</td>
                                <td>${t.installments_total}x de R$ ${(t.amount / t.installments_total).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="openEditTransactionModal(${t.id}, ${cardId})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${t.installments_total > 1 ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="openAnticipateModal(${t.id}, ${cardId})" title="Antecipar parcelas">
                                        <i class="fas fa-forward"></i>
                                    </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id}, ${cardId}, '${cardName}')" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        new bootstrap.Modal(document.getElementById('viewTransactionsModal')).show();
    } catch (error) {
        console.error('Erro ao carregar transações:', error);
        showToast('Erro ao carregar transações', 'error');
    }
}

async function openAnticipateModal(transactionId, cardId) {
    try {
        document.getElementById('anticipateTransactionId').value = transactionId;
        document.getElementById('anticipateCardId').value = cardId;
        document.getElementById('interestResult').innerHTML = '';

        const response = await fetch(`/cards/api/transactions/${transactionId}`);
        const tx = await response.json();

        document.getElementById('anticipateTxTitle').textContent = tx.description;
        document.getElementById('anticipateTxMeta').textContent = `Total: R$ ${tx.amount.toFixed(2)} | ${tx.installments_total} parcelas`;

        const target = tx.anticipation_target;
        const targetLabel = `${String(target.month).padStart(2,'0')}/${target.year}`;

        const container = document.getElementById('anticipateInstallments');

        if (!tx.installments || tx.installments.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">Nenhuma parcela encontrada.</div>';
        } else {
            const targetNum = _ymToNumber(target.year, target.month);

            const rows = tx.installments.map(inst => {
                const stmtNum = _ymToNumber(inst.statement_year || 0, inst.statement_month || 0);
                const isFuture = stmtNum > targetNum;
                const disabled = inst.paid || !isFuture;
                const reason = inst.paid ? 'paga' : (!isFuture ? 'não é futura' : '');

                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${inst.id}" id="inst_${inst.id}" ${disabled ? 'disabled' : ''}>
                        <label class="form-check-label" for="inst_${inst.id}">
                            Parcela ${inst.installment_number}/${inst.total_installments} — R$ ${inst.amount.toFixed(2)} — fatura ${String(inst.statement_month).padStart(2,'0')}/${inst.statement_year}
                            ${disabled ? `<small class="text-muted">(${reason})</small>` : ''}
                        </label>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="mb-2"><strong>Destino:</strong> ${target.kind === 'current' ? 'Fatura atual' : 'Próxima fatura'} (${targetLabel})</div>
                ${rows}
            `;
        }

        new bootstrap.Modal(document.getElementById('anticipateModal')).show();
    } catch (error) {
        console.error('Erro ao abrir modal de antecipação:', error);
        showToast('Erro ao abrir antecipação', 'error');
    }
}

function _selectedInstallmentIds() {
    return Array.from(document.querySelectorAll('#anticipateInstallments input[type=checkbox]:checked'))
        .map(el => parseInt(el.value));
}

function _selectedPrincipal() {
    const checked = document.querySelectorAll('#anticipateInstallments input[type=checkbox]:checked');
    let principal = 0;
    checked.forEach(el => {
        const label = el.nextElementSibling;
        const m = label.textContent.match(/R\$\s([0-9]+\.[0-9]+)/);
        if (m) principal += parseFloat(m[1]);
    });
    return principal;
}

async function calcInterest() {
    const principal = _selectedPrincipal();
    const rate = parseFloat(document.getElementById('interestRate').value || '0');
    const days = parseFloat(document.getElementById('interestDays').value || '0');

    if (principal <= 0) {
        document.getElementById('interestResult').innerHTML = '<small class="text-muted">Selecione pelo menos uma parcela.</small>';
        return;
    }

    try {
        const response = await fetch('/cards/api/simple-interest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({principal, rate_percent_month: rate, days})
        });
        const data = await response.json();

        document.getElementById('interestResult').innerHTML = 
            `<small class="text-muted">Principal: R$ ${data.principal.toFixed(2)} | Juros: R$ ${data.interest.toFixed(2)} | Total: R$ ${data.total.toFixed(2)} ( ${data.formula} )</small>`;
    } catch (e) {
        document.getElementById('interestResult').innerHTML = '<small class="text-danger">Erro ao calcular juros.</small>';
    }
}

async function confirmAnticipation() {
    const transactionId = document.getElementById('anticipateTransactionId').value;
    const ids = _selectedInstallmentIds();

    if (ids.length === 0) {
        showToast('Selecione parcelas futuras para antecipar.', 'error');
        return;
    }

    if (!confirm(`Antecipar ${ids.length} parcela(s) para a fatura atual/próxima conforme regra?`)) return;

    try {
        const response = await fetch(`/cards/api/transactions/${transactionId}/anticipate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({installment_ids: ids})
        });
        const data = await response.json();

        if (!response.ok) {
            showToast(data.error || 'Erro ao antecipar', 'error');
            return;
        }

        showToast(`Antecipação ok: movidas ${data.moved}, ignoradas ${data.skipped}.`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('anticipateModal')).hide();
        loadCards();
    } catch (error) {
        console.error('Erro ao antecipar:', error);
        showToast('Erro ao antecipar', 'error');
    }
}

async function deleteTransaction(transactionId, cardId, cardName) {
    if (!confirm('Tem certeza que deseja excluir esta transação?')) {
        return;
    }

    try {
        const response = await fetch(`/cards/api/transactions/${transactionId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Transação excluída!', 'success');
            viewTransactions(cardId, cardName);
            loadCards();
        }
    } catch (error) {
        console.error('Erro ao deletar transação:', error);
        showToast('Erro ao deletar transação', 'error');
    }
}

document.addEventListener('DOMContentLoaded', loadCards);
</script>
{% endblock %}
