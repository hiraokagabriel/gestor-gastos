<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Gestor de Gastos{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        .notification-badge {
            position: relative;
        }
        .notification-badge .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.65rem;
            padding: 0.25em 0.5em;
        }
        
        /* Ocultar navegação temporal na página do calendário */
        body.calendar-page .temporal-navigation {
            display: none !important;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body{% if request.endpoint == 'calendar.index' %} class="calendar-page"{% endif %}>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-wallet"></i> Gestor de Gastos
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cards">
                            <i class="fas fa-credit-card"></i> Cartões
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/invoices">
                            <i class="fas fa-file-invoice-dollar"></i> Faturas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/bills">
                            <i class="fas fa-file-invoice"></i> Boletos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/accounts">
                            <i class="fas fa-money-bill-wave"></i> Contas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/calendar">
                            <i class="fas fa-calendar-alt"></i> Calendário
                        </a>
                    </li>
                    <li class="nav-item notification-badge">
                        <a class="nav-link" href="/notifications">
                            <i class="fas fa-bell"></i> Notificações
                            <span id="notificationBadge" class="badge bg-danger" style="display: none;">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {% set show_temporal_nav = request.endpoint in ['dashboard.index', 'invoices.index', 'bills.index', 'accounts.index'] %}
    {% if show_temporal_nav %}
    <!-- Barra de Navegação Temporal (contextual por tela) -->
    <div class="bg-light border-bottom py-2 temporal-navigation">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-3">
                        <span class="text-muted">
                            <i class="fas fa-calendar-day"></i> <strong>Hoje:</strong> 
                            <span id="currentDateDisplay"></span>
                        </span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center justify-content-end gap-2 flex-wrap">
                        <span class="text-muted">
                            <i class="fas fa-eye"></i> <strong>Período:</strong>
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="prevMonth()" title="Mês anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="badge bg-primary" id="temporalMonthDisplay" style="min-width: 120px; font-size: 0.9rem;">
                            Carregando...
                        </span>
                        <span class="text-muted small" id="temporalAppliedHint" style="display: none;">
                            (aplicado: <span id="temporalAppliedDisplay"></span>)
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="nextMonth()" title="Próximo mês">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-sm btn-success" id="temporalApplyBtn" onclick="applyViewingDate()" disabled>
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                        <button class="btn btn-sm btn-primary" id="temporalClearBtn" onclick="clearViewingDate()">
                            <i class="fas fa-home"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Alerta de Modo Simulação -->
            <div id="temporalAlert" class="alert alert-warning alert-sm mt-2 mb-0" style="display: none; padding: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Modo Simulação Ativo</strong> - Você está visualizando dados de outro período.
                <button class="btn btn-sm btn-warning ms-2" onclick="clearViewingDate()">
                    Voltar para Hoje
                </button>
            </div>
            
            <!-- Saldo Projetado (aparece quando navega para outros meses) -->
            <div id="projectedBalanceSection" class="mt-2" style="display: none;">
                <!-- Conteúdo preenchido via JavaScript -->
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="{% if request.endpoint == 'calendar.index' %}container-fluid{% else %}container-fluid{% endif %} my-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Navegação Temporal -->
    <script src="{{ url_for('static', filename='js/temporal-nav.js') }}"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Display Current Date -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric' 
            });
            const currentDateEl = document.getElementById('currentDateDisplay');
            if (currentDateEl) {
                currentDateEl.textContent = dateStr;
            }
            
            // Carregar contador de notificações
            updateNotificationBadge();
        });
        
        async function updateNotificationBadge() {
            try {
                const response = await fetch('/notifications/api/notifications/count');
                const data = await response.json();
                const badge = document.getElementById('notificationBadge');
                
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'inline';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao atualizar badge de notificações:', error);
            }
        }
        
        // Atualizar badge a cada 2 minutos
        setInterval(updateNotificationBadge, 120000);
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>