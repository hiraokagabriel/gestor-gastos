{% extends 'base.html' %}

{% block title %}Calend√°rio Financeiro - Gestor de Gastos{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
/* Eventos maiores e mais vis√≠veis */
.fc-event {
    cursor: pointer;
    font-size: 0.9rem;
    padding: 4px 6px !important;
    margin: 2px 0 !important;
    border-radius: 4px !important;
    font-weight: 600 !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
}

.fc-event:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    z-index: 999;
}

/* Estilos espec√≠ficos por tipo */
.event-invoice {
    font-weight: 700 !important;
    border-left: 4px solid #fff !important;
}

.event-bill {
    font-weight: 600 !important;
    border-left: 4px solid #000 !important;
}

.event-installment {
    font-style: italic;
    opacity: 0.9;
}

.event-recurring {
    border-style: dashed !important;
    border-width: 2px !important;
}

.event-income {
    border-left: 4px solid #fff !important;
}

/* Legenda melhorada */
.legend-item {
    display: inline-block;
    margin-right: 20px;
    margin-bottom: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    background-color: #f8f9fa;
    transition: background-color 0.2s;
}

.legend-item:hover {
    background-color: #e9ecef;
}

.legend-color {
    display: inline-block;
    width: 20px;
    height: 20px;
    margin-right: 8px;
    border-radius: 4px;
    vertical-align: middle;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.legend-icon {
    font-size: 1.2rem;
    margin-right: 6px;
    vertical-align: middle;
}

/* Tooltip customizado */
.event-tooltip {
    position: absolute;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.85rem;
    z-index: 10000;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-width: 300px;
}

/* Melhorar visualiza√ß√£o do calend√°rio */
.fc-daygrid-day-number {
    font-size: 1.1rem;
    font-weight: 600;
}

.fc-col-header-cell {
    background-color: #f8f9fa;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85rem;
}

.fc-daygrid-day.fc-day-today {
    background-color: #fff3cd !important;
}

/* Filtros */
.filter-buttons {
    margin-bottom: 15px;
}

.filter-buttons .btn {
    margin-right: 5px;
    margin-bottom: 5px;
}

/* Melhorar bot√µes de navega√ß√£o do calend√°rio */
.fc .fc-button {
    padding: 0.6em 1em;
    font-size: 1rem;
}

.fc .fc-toolbar-title {
    font-size: 1.5rem;
    font-weight: 700;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-calendar-alt"></i> Calend√°rio Financeiro</h2>
            <p class="text-muted">Visualize todos os seus compromissos financeiros. Use os bot√µes no calend√°rio para navegar entre meses.</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="filter-buttons">
                <button class="btn btn-sm btn-outline-primary active" id="filterAll" onclick="filterEvents('all')">
                    <i class="fas fa-list"></i> Todos
                </button>
                <button class="btn btn-sm btn-outline-danger" id="filterInvoice" onclick="filterEvents('invoice')">
                    <i class="fas fa-credit-card"></i> Faturas
                </button>
                <button class="btn btn-sm btn-outline-warning" id="filterBill" onclick="filterEvents('bill')">
                    <i class="fas fa-file-invoice"></i> Boletos
                </button>
            </div>
        </div>
    </div>

    <!-- Legenda Completa -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h6 class="mb-3"><i class="fas fa-info-circle"></i> Legenda de Eventos:</h6>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">üí≥</span>
                        <span class="legend-color" style="background-color: #dc3545;"></span>
                        <span><strong>Faturas de Cart√µes</strong> (Abertas)</span>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">üìÑ</span>
                        <span class="legend-color" style="background-color: #ffc107;"></span>
                        <span><strong>Boletos</strong> (Pendentes)</span>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">üîπ</span>
                        <span class="legend-color" style="background-color: #0dcaf0;"></span>
                        <span><strong>Parcelas</strong> Individuais</span>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">üîÅ</span>
                        <span class="legend-color" style="background-color: #6f42c1;"></span>
                        <span><strong>Despesas Recorrentes</strong></span>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">üíµ</span>
                        <span class="legend-color" style="background-color: #20c997;"></span>
                        <span><strong>Receitas Recorrentes</strong></span>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="legend-item">
                        <span class="legend-icon">‚úì</span>
                        <span class="legend-color" style="background-color: #28a745;"></span>
                        <span><strong>J√° Pagos</strong></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calend√°rio -->
    <div class="card shadow">
        <div class="card-body p-3">
            <div id='calendar'></div>
        </div>
    </div>
</div>

<!-- Tooltip -->
<div id="eventTooltip" class="event-tooltip" style="display: none;"></div>

<!-- Modal de Detalhes do Evento -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <a id="eventModalLink" href="#" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Ver Detalhes Completos
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/pt-br.global.min.js'></script>
<script>
let calendar;
let allEvents = [];
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        buttonText: {
            today: 'Hoje',
            month: 'M√™s',
            week: 'Semana',
            day: 'Dia',
            list: 'Lista'
        },
        events: loadEvents,
        eventClick: function(info) {
            showEventDetails(info.event);
        },
        eventMouseEnter: function(info) {
            showTooltip(info.event, info.el);
        },
        eventMouseLeave: function(info) {
            hideTooltip();
        },
        eventDidMount: function(info) {
            // Adicionar classe para anima√ß√£o
            info.el.style.animation = 'fadeIn 0.3s ease-in';
        }
    });
    
    calendar.render();
});

async function loadEvents(fetchInfo, successCallback, failureCallback) {
    try {
        const response = await fetch(
            `/calendar/api/events?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`
        );
        const events = await response.json();
        allEvents = events;
        
        // Aplicar filtro atual
        const filteredEvents = filterEventsByType(events, currentFilter);
        successCallback(filteredEvents);
    } catch (error) {
        console.error('Erro ao carregar eventos:', error);
        failureCallback(error);
    }
}

function filterEventsByType(events, type) {
    if (type === 'all') return events;
    return events.filter(event => event.extendedProps.type === type);
}

function filterEvents(type) {
    currentFilter = type;
    
    // Atualizar bot√µes ativos
    document.getElementById('filterAll').classList.remove('active');
    document.getElementById('filterInvoice').classList.remove('active');
    document.getElementById('filterBill').classList.remove('active');
    
    if (type === 'all') {
        document.getElementById('filterAll').classList.add('active');
    } else if (type === 'invoice') {
        document.getElementById('filterInvoice').classList.add('active');
    } else if (type === 'bill') {
        document.getElementById('filterBill').classList.add('active');
    }
    
    calendar.refetchEvents();
}

function showTooltip(event, element) {
    const tooltip = document.getElementById('eventTooltip');
    const data = event.extendedProps;
    
    let html = `
        <div style="font-weight: bold; margin-bottom: 5px;">
            ${data.icon} ${event.title}
        </div>
        <div><strong>Valor:</strong> R$ ${data.amount.toFixed(2)}</div>
        <div><strong>Data:</strong> ${new Date(event.start).toLocaleDateString('pt-BR')}</div>
    `;
    
    if (data.status) {
        html += `<div><strong>Status:</strong> ${data.status}</div>`;
    }
    
    if (data.card_name) {
        html += `<div><strong>Cart√£o:</strong> ${data.card_name}</div>`;
    }
    
    if (data.category) {
        html += `<div><strong>Categoria:</strong> ${data.category}</div>`;
    }
    
    tooltip.innerHTML = html;
    
    // Posicionar tooltip
    const rect = element.getBoundingClientRect();
    tooltip.style.left = (rect.left + window.scrollX) + 'px';
    tooltip.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    tooltip.style.display = 'block';
}

function hideTooltip() {
    document.getElementById('eventTooltip').style.display = 'none';
}

function showEventDetails(event) {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    const data = event.extendedProps;
    
    document.getElementById('eventModalTitle').innerHTML = `${data.icon} ${event.title}`;
    
    let bodyHtml = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>üìÖ Data:</strong> ${new Date(event.start).toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })}</p>
            </div>
            <div class="col-md-6">
                <p><strong>üí∞ Valor:</strong> <span class="text-success fs-5">R$ ${data.amount.toFixed(2)}</span></p>
            </div>
        </div>
        <hr>
        <p><strong>üè∑Ô∏è Tipo:</strong> ${data.typeLabel}</p>
    `;
    
    if (data.description) {
        bodyHtml += `<p><strong>üìù Descri√ß√£o:</strong> ${data.description}</p>`;
    }
    
    if (data.status) {
        const statusBadge = data.status === 'Paga' || data.status === 'Pago' 
            ? '<span class="badge bg-success">‚úì ' + data.status + '</span>'
            : '<span class="badge bg-warning">' + data.status + '</span>';
        bodyHtml += `<p><strong>üìä Status:</strong> ${statusBadge}</p>`;
    }
    
    if (data.card_name) {
        bodyHtml += `<p><strong>üí≥ Cart√£o:</strong> ${data.card_name}</p>`;
    }
    
    if (data.category) {
        bodyHtml += `<p><strong>üìÇ Categoria:</strong> ${data.category}</p>`;
    }
    
    document.getElementById('eventModalBody').innerHTML = bodyHtml;
    document.getElementById('eventModalLink').href = data.link || '#';
    
    modal.show();
}

// Anima√ß√£o CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}